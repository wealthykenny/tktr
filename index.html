<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TR-KING | Portfolio</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css"> 
    
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
    <header>
        <div class="container nav-flex">
            <div class="logo">USER: <span class="highlight">TR_KING</span></div>
            <div data-netlify-identity-menu></div> 
        </div>
    </header>

    <main>
        <section class="hero">
            <img id="site-avatar" src="https://huggingface.co/spaces/Lordecyhper/stohrage/resolve/main/IMG_8296.jpeg" class="pixel-avatar" alt="Profile Avatar">
            
            <h1>
                <span id="hero-heading">PROFESSIONAL PORTFOLIO</span> 
                <br>
                <span id="hero-subheading" style="color: var(--neon-purple); font-size: 0.8em; letter-spacing: 3px;">TR-KING</span>
            </h1>
            
            <div class="typewriter">
                <span id="typing-text"></span><span class="cursor"></span>
            </div>
            
            <button class="btn-pixel" id="hero-btn" onclick="document.getElementById('stats').scrollIntoView({behavior:'smooth'})">Initialize Profile</button>
        </section>

        <section class="stats-section container" id="stats">
            <div class="rpg-card">
                <div class="stat-grid" id="stat-container">
                    </div>
            </div>
        </section>
    </main>

    <script>
        // --- 1. SETTINGS & CONTENT LOADER (The Brain) ---
        async function loadCMSData() {
            try {
                // A. Load Theme Settings (Colors)
                const settingsReq = await fetch('/data/settings.json');
                if (settingsReq.ok) {
                    const settings = await settingsReq.json();
                    if(settings.primary_color) document.documentElement.style.setProperty('--neon-green', settings.primary_color);
                    if(settings.secondary_color) document.documentElement.style.setProperty('--neon-purple', settings.secondary_color);
                    if(settings.bg_color) document.documentElement.style.setProperty('--bg-color', settings.bg_color);
                }

                // B. Load Hero Content (Text & Avatar)
                const heroReq = await fetch('/data/hero.json');
                if (heroReq.ok) {
                    const hero = await heroReq.json();
                    
                    // Update Text
                    if(hero.heading) document.getElementById('hero-heading').innerText = hero.heading;
                    if(hero.btn_text) document.getElementById('hero-btn').innerText = hero.btn_text;
                    
                    // Update Avatar
                    if(hero.avatar) {
                        // Fix for Netlify media path if it starts with "assets/"
                        let avatarPath = hero.avatar;
                        if (!avatarPath.startsWith('http') && !avatarPath.startsWith('/')) {
                            avatarPath = '/' + avatarPath;
                        }
                        document.getElementById('site-avatar').src = avatarPath;
                    }

                    // Update Typewriter Text (If subtext exists, make it the phrase)
                    if(hero.subtext) {
                        phrases = [hero.subtext];
                    }
                }

                // C. Load Stats (Skills)
                const statsReq = await fetch('/data/stats.json');
                if (statsReq.ok) {
                    const statsData = await statsReq.json();
                    const container = document.getElementById('stat-container');
                    
                    if(statsData.skills) {
                        container.innerHTML = statsData.skills.map(s => `
                            <div class="stat-item">
                                <label>${s.label || 'Skill'} <span class="xp-text">${s.value}%</span></label>
                                <div class="stat-bar-container">
                                    <div class="stat-bar" style="width: ${s.value}%"></div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (e) { 
                console.log("CMS data waiting for initialization...", e); 
            }
        }

        // --- 2. TYPEWRITER EFFECT ---
        let phrases = ["MACHINE LEARNING EXPERT", "FULL STACK DEV"]; // Defaults
        const textElement = document.getElementById('typing-text');
        let pIdx = 0, cIdx = 0, isDel = false;

        function type() {
            const curr = phrases[pIdx];
            // Safety check to prevent crash if phrase is undefined
            if (!curr) return; 
            
            textElement.textContent = isDel ? curr.substring(0, cIdx--) : curr.substring(0, cIdx++);
            
            let speed = isDel ? 50 : 100;
            
            if (!isDel && cIdx > curr.length) { 
                isDel = true; 
                speed = 2000; // Pause at end
            } else if (isDel && cIdx < 0) { 
                isDel = false; 
                pIdx = (pIdx + 1) % phrases.length; 
                speed = 500; 
            }
            
            setTimeout(type, speed);
        }

        // --- 3. IDENTITY REDIRECT LOGIC ---
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", user => {
                if (!user) {
                    window.netlifyIdentity.on("login", () => { 
                        document.location.href = "/admin/"; 
                    });
                }
            });
        }

        // --- 4. START ENGINE ---
        document.addEventListener('DOMContentLoaded', () => {
            loadCMSData(); // Load CMS data first
            type();        // Then start typing
        });
    </script>
</body>
</html>
